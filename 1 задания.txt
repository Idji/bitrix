– Дано: интернет магазин на "1с-битрикс: Бизнес", каталог, корзина и оформление заказа реализованы нативными компонентами (catalog, sale.basket.basket, sale.order.full). 
Задача:  реализовать бонусный счет пользователя, на который начисляются средства за каждый оплаченный заказ в размере X процентов от стоимости товаров в заказе. Покупатель может оплатить часть следующих заказов со своего бонусного счете в размере Y процентов от стоимости товаров. У данной программы лояльности должны быть настройки, где выставляется процент, начисляемый с заказа, а также максимальный процент, который можно оплатить с бонусного счета.
Решение:
В качестве бонусного счёта можно использовать счета покупателей в модуле "Интернет-магазин".
Для хранения настроек нужно создать отдельный инфоблок с двумя свойствами типа число: "Процент стоимости в бонус" и "Максимальный процент". Далее создать элемент этого инфоблока, куда и запишутся настройки.
Далее, необходимо каждый раз при оплате заказа, начислять пользователю бонусы. Для этого в файле /bitrix/php_interface/init.php добавим обработчик события изменения статуса заказа - "OnSalePayOrder". В случае, если заказ оплачен, в обработчике начисляются бонусы на сумму заказа. Кол-во бонусов определяется с помощью API-запроса к инфоблоку с настройками. 
Последний штрих - оплата бонусами, для этого понадобится модифицировать шаблон компонента bitrix:sale.order.full а также написать файл result_modifier.php .Теперь подробнее - в шаблоне необходимо отредактировать вывод шага 5 step5.php так, чтобы пользователь получил актуальную информацию о том, какой процент заказа будет оплачен бонусами, если будет выбран способ оплыта - с внутреннего счёта. В result_modifier.php если пользователь оплачивает бонусами, нужно оплатить часть заказа с помощью функции CSaleUserAccount::Pay. Информация о максимально возможной сумме оплаты бонусами берется с помощью API из инфоблока с настройками.










